using System.Net.Http.Json;

namespace CommitmentsBlazor.Services;

public class ApiClient
{
    private readonly HttpClient _http;
    public ApiClient(HttpClient http) { _http = http; }

    public record CommitmentSummary(Guid Id, string Goal, string Currency, long StakeAmountMinor, DateTime DeadlineUtc, string Status, double ProgressPercent, string RiskBadge);

    public async Task<IReadOnlyList<CommitmentSummary>> GetCommitmentsAsync(Guid userId, CancellationToken ct = default)
    {
        var url = $"commitments?userId={userId}";
        var doc = await _http.GetFromJsonAsync<ResponseWrapper>(url, ct) ?? new ResponseWrapper();
        return doc.items ?? Array.Empty<CommitmentSummary>();
    }

    public async Task<CommitmentSummary?> GetCommitmentAsync(Guid id, CancellationToken ct = default)
        => await _http.GetFromJsonAsync<CommitmentSummary>($"commitments/{id}", ct);

    private class ResponseWrapper
    {
        public List<CommitmentSummary>? items { get; set; }
    }
}
